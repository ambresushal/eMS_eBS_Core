tinymce.PluginManager.add("annotate", function (t, n) { function e() { var n = this; t.on("NodeChange", function (t) { n.active(a(t.element)) }) } function a(t) { return t && "SPAN" === t.nodeName && "annotation" == t.className } function o() { var n = {}, e = (t.dom, ""), o = "", d = t.selection.getNode(), c = a(t.selection.getStart()); c ? (e = t.dom.getAttrib(d, "data-annotation-value"), o = n.text = d.innerHTML) : o = r() || "", n.text = o, t.windowManager.open({ title: "Annotation", body: [{ type: "textbox", name: "annotationField", minWidth: 340, minHeight: 150, multiline: !0, label: "", value: e }, { type: "textbox", name: "textToDisplayField", size: 40, label: "Text to display", value: o, onkeyup: function () { n.text = this.value() }, onPostRender: function () { this.getEl().previousSibling.innerHTML = 'Text to display <span style="color:#ff0000">*</span>' } }], onsubmit: function (e) { function a() { if ("" == n.text.trim()) return t.windowManager.alert("'Text to display' cannot be blank"), s = !1, !1; if (c) "" == e.data.annotationField.trim() ? l() : $(d).attr("data-annotation-value", e.data.annotationField.replace(/"/g, "&quot;")), o != n.text && (d.innerText = n.text); else { n.text = i(n.text); var a = n.text.search(/\ $/) > 0 ? " " : ""; t.selection.setContent('<span class="annotation" data-annotation-value="' + e.data.annotationField.replace(/"/g, "&quot;").trim() + '">' + n.text.trim() + "</span>" + a) } } function r() { t.undoManager.transact(a) } var s = !0; return r(), s ? void 0 : !1 } }) } function i(t) { return t.replace(/<span\ [^(class)]*class="annotation"[^>]*>/g, "") } function l() { if (a(t.selection.getStart())) { var n = t.selection.getNode(); selectedText = n.innerHTML, t.dom.remove(n, selectedText), t.undoManager.add() } } function r() { return t.selection.getContent() || !1 } t.addButton("annotate", { title: "Insert/edit annotation", image: n + "/img/annotation.png", onclick: o, onpostrender: e }), t.addButton("delete-annotation", { title: "Remove annotation", image: n + "/img/delete-annotation.png", onclick: l, onpostrender: e }), t.addMenuItem("annotate", { text: "Annotate", image: n + "/img/annotation.png", context: "tools", onclick: o }) });